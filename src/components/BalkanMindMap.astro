---
const { nav } = Astro.props;

// Construcción de la data bilateral estricta
const rootTitle = nav.portfolioSub?.split(':')[1]?.trim() || 'PC-Grundlagen und Fachenglisch';

const chartNodes = [
  { id: "group", tags: ["ig"] },
  { id: "rootNode", stpid: "group", name: rootTitle, tags: ['belinda'] }
];

for (let i = 1; i <= 14; i++) {
  const modTitle = nav[`m${i}T`];
  if (!modTitle) continue;

  const isLeft = i > 7;
  const modId = `mod-${i}`;
  
  chartNodes.push({ 
    id: modId, 
    pid: isLeft ? "group" : "rootNode", 
    name: modTitle 
  });

  const subPoints = nav[`m${i}D`];
  if (Array.isArray(subPoints)) {
    subPoints.forEach((point, index) => {
      chartNodes.push({ 
        id: `${modId}-s${index}`, 
        pid: modId, 
        name: point 
      });
    });
  }
}
---

<div class="balkan-container border-4 border-black rounded-[2.5rem] overflow-hidden shadow-[10px_10px_0px_#000] bg-white relative">
  <div id="tree"></div>
</div>

<script is:inline src="https://balkan.app/js/OrgChart.js"></script>

<script is:inline define:vars={{ chartNodes }}>
  function renderChart() {
    const container = document.getElementById("tree");
    if (!container || !window.OrgChart) return;

    OrgChart.templates.mindMap = Object.assign({}, OrgChart.templates.ana);
    
    // 1. ESPACIO DEL NODO: Aumentamos el tamaño para que el texto no se amontone
    OrgChart.templates.mindMap.size = [300, 40]; 
    OrgChart.templates.mindMap.minus = OrgChart.templates.belinda.minus = '';
    OrgChart.templates.mindMap.node = ''; 
    OrgChart.templates.mindMap.link = 
        `<path stroke="#575757" stroke-width="2" fill="none" d="M{xa},{ya} C{xb},{yb} {xc},{yc} {xd},{yd}" />`;
    
    // 2. TEXTO: data-width amplio para que Balkan no corte las palabras prematuramente
    OrgChart.templates.mindMap.field_0 = 
        `<text data-width="280" style="font-size: 15px;" fill="#333" x="150" y="20" text-anchor="middle">{val}</text>`;
    
    OrgChart.templates.invisibleGroup.plus = '';
    OrgChart.templates.invisibleGroup.minus = '';
    
    OrgChart.templates.belinda.size = [200, 200];
    OrgChart.templates.belinda.defs = OrgChart.gradientCircleForDefs('circle', [
        '#F57C00', '#FFCA28', '#039BE5', '#039BE5', '#33b864', '#F57C00'], 100, 10);
    OrgChart.templates.belinda.node =
        `<use x="0" y="0" xlink:href="#circle" />
        <g transform="matrix(3.5,0,0,3.5,20,20)">
            <circle cx="12" cy="22" r="12" fill="#039BE5"></circle>
            <circle cx="33" cy="14" r="10" fill="#FFCA28"></circle>
            <circle cx="30" cy="32" r="8" fill="#F57C00"></circle>
        </g>`;
    OrgChart.templates.belinda.field_0 = 
        `<text style="font-size: 18px; font-weight: 900;" text-anchor="middle" fill="#000" x="100" y="240">{val}</text>`;

    let chart = new OrgChart(container, {
        template: 'mindMap',
        mouseScrool: OrgChart.action.zoom,
        nodeMouseClick: OrgChart.action.none,
        enableSearch: false,
        // 3. SEPARACIÓN: Aumentamos drásticamente el espacio entre hermanos y niveles
        levelSeparation: 250, 
        siblingSeparation: 60,
        padding: 50,
        orientation: OrgChart.orientation.right,
        scaleInitial: OrgChart.match.boundary,
        nodeBinding: { field_0: 'name' },
        tags: {
            "ig": {
                template: "invisibleGroup",
                subTreeConfig: {
                    orientation: OrgChart.orientation.left,
                    template: 'mindMap'
                }
            },
            "belinda": { template: 'belinda' }
        }
    });

    chart.on('node-initialized', function(sender, args) {
        if (!args.node.children.length) {
            args.node.tags.push('no-children');
        }
    });

    chart.load(chartNodes);
  }

  renderChart();
  document.addEventListener('astro:page-load', renderChart);
</script>

<style is:global>
  .balkan-container {
    width: 100%;
    height: 850px; 
  }
  #tree { width: 100%; height: 100%; }

  /* Alineación de textos corregida: no usamos center para evitar que las líneas los pisen */
  .no-children text {
    text-anchor: start !important;
    transform: translateX(20px) !important;
  }
  
  [lcn="ig"].no-children text {
    text-anchor: end !important;
    transform: translateX(-20px) !important;
  }

  /* Colores dinámicos por ID para que se vea como la imagen profesional */
  [data-l-id*="mod-1"] path, [data-l-id*="mod-8"] path { stroke: #FFCA28 !important; }
  [data-l-id*="mod-2"] path, [data-l-id*="mod-9"] path { stroke: #039BE5 !important; }
  [data-l-id*="mod-3"] path, [data-l-id*="mod-10"] path { stroke: #F57C00 !important; }
</style>