---
// src/components/Navbar.astro
const { lang: propLang } = Astro.props;

const urlPath = Astro.url.pathname;
const rawBase = import.meta.env.BASE_URL;
const base = rawBase.endsWith('/') ? rawBase : `${rawBase}/`;

// 1. L√≥gica para detectar el idioma y el sub-camino actual
const segments = urlPath.replace(base, '').split('/').filter(Boolean);
// El primer segmento despu√©s de la base suele ser el idioma (es, de, en...)
const urlLang = segments[0]; 
const lang = propLang || urlLang || "de"; 

// 2. Capturamos todo lo que viene DESPU√âS del idioma
// Si la URL es /base/es/modul-1, currentSubPath ser√° 'modul-1'
const currentSubPath = segments.slice(1).join('/');

const languages = [
  { code: "de", label: "Deutsch", flag: "üá©üá™" },
  { code: "es", label: "Espa√±ol", flag: "üá™üá∏" },
  { code: "en", label: "English", flag: "üá∫üá∏" },
  { code: "fa", label: "ŸÅÿßÿ±ÿ≥€å", flag: "üáÆüá∑", dir: "rtl" },
  { code: "ru", label: "–†—É—Å—Å–∫–∏–π", flag: "üá∑üá∫" },
];

const activeLangCode = languages.some(l => l.code === lang) ? lang : "de";
const currentLang = languages.find((l) => l.code === activeLangCode);

const t = {
  es: { home: "Inicio", modules: "M√≥dulos", mindmap: "Contacto", current: "Actual" },
  en: { home: "Home", modules: "Modules", mindmap: "Contact", current: "Current" },
  de: { home: "Start", modules: "Module", mindmap: "Kontakt", current: "Aktiv" },
  ru: { home: "–ì–ª–∞–≤–Ω–∞—è", modules: "–ú–æ–¥—É–ª–∏", mindmap: "–ö–æ–Ω—Ç–∞–∫—Ç—ã", current: "–¢–µ–∫." },
  fa: { home: "ÿµŸÅÿ≠Ÿá ÿßÿµŸÑ€å", modules: "ŸÖÿß⁄òŸàŸÑ‚ÄåŸáÿß", mindmap: "ÿ™ŸÖÿßÿ≥", current: "ŸÅÿπŸÑ€å" }
};

const nav = t[activeLangCode];
---

<nav class="sticky top-0 z-[100] w-full bg-white/90 backdrop-blur-md border-b border-gray-100 shadow-sm font-inter">
  <div class="max-w-5xl mx-auto px-4">
    <div class="flex justify-between h-16 items-center">
      
      <a href={`${base}${activeLangCode}/`} class="font-black text-2xl text-blue-600 tracking-tighter">
        BEBE<span class="text-gray-800">CUTE</span>
      </a>

      <div class="flex items-center gap-2 md:gap-8">
        <div class="flex items-center gap-4 md:gap-8">
          <a href={`${base}${activeLangCode}/#home`} class="text-sm md:text-base font-bold text-gray-600 hover:text-purple-600 transition-colors tracking-tight">
            {nav.home}
          </a>
          <a href={`${base}${activeLangCode}/#portfolio`} class="text-sm md:text-base font-bold text-gray-600 hover:text-purple-600 transition-colors tracking-tight">
            {nav.modules}
          </a>
          <a href={`${base}${activeLangCode}/#mindmap`} class="text-sm md:text-base font-bold text-gray-600 hover:text-purple-600 transition-colors tracking-tight">
            {nav.mindmap}
          </a>
        </div>

        <div class="relative inline-block text-left">
          <button id="lang-menu-btn" class="flex items-center gap-1.5 bg-gray-50 border border-gray-200 px-3 py-2 md:px-4 md:py-2 rounded-xl hover:bg-gray-100 transition-all group">
            <svg class="w-4 h-4 text-gray-400 group-hover:text-purple-600 transition-colors" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="2" y1="12" x2="22" y2="12"></line>
              <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
            </svg>
            <span class="text-xs md:text-sm font-black text-gray-700 uppercase">{currentLang.code}</span>
          </button>

          <div id="lang-dropdown" class="hidden absolute right-0 mt-2 w-44 md:w-52 bg-white border border-gray-100 rounded-2xl shadow-xl overflow-hidden ring-1 ring-black ring-opacity-5 animate-in fade-in zoom-in-95 duration-100">
            {languages.map((l) => {
              const isActive = l.code === activeLangCode;
              // 3. CONSTRUCCI√ìN DEL ENLACE DIN√ÅMICO
              // Concatenamos base + nuevo idioma + sub-camino actual
              const targetUrl = `${base}${l.code}/${currentSubPath}`;
              
              return (
                <a 
                  href={targetUrl} 
                  class={`flex items-center justify-between px-4 py-3.5 text-sm transition-all border-b border-gray-50 last:border-0 ${isActive ? 'bg-purple-50 text-purple-700 font-bold' : 'text-gray-600 hover:bg-gray-50'}`}
                  dir={l.dir || 'ltr'}
                >
                  <div class="flex items-center gap-3">
                    <span class="text-[11px] font-black opacity-30 w-5">{l.code.toUpperCase()}</span>
                    <span>{l.label}</span>
                  </div>
                  {isActive && (
                    <span class="text-[9px] bg-purple-600 text-white px-2 py-0.5 rounded-md font-black uppercase tracking-tighter">
                      {nav.current}
                    </span>
                  )}
                </a>
              );
            })}
          </div>
        </div>
      </div>
    </div>
  </div>
</nav>

<script>
  const initNav = () => {
    const btn = document.getElementById("lang-menu-btn");
    const dropdown = document.getElementById("lang-dropdown");
    
    btn?.addEventListener("click", (e) => {
      e.stopPropagation();
      dropdown?.classList.toggle("hidden");
    });

    document.addEventListener("click", () => {
      dropdown?.classList.add("hidden");
    });
  };

  initNav();
  document.addEventListener('astro:after-swap', initNav);
</script>