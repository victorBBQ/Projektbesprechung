---
// src/components/Navbar.astro
const { lang: propLang } = Astro.props;

const urlPath = Astro.url.pathname;
const rawBase = import.meta.env.BASE_URL;
const base = rawBase.endsWith('/') ? rawBase : `${rawBase}/`;

const segments = urlPath.replace(base, '').split('/').filter(Boolean);
const urlLang = segments[0]; 
const lang = propLang || urlLang || "de"; 

const currentSubPath = segments.slice(1).join('/');

const languages = [
  { code: "de", label: "Deutsch" },
  { code: "es", label: "Español" },
  { code: "en", label: "English" },
  { code: "fa", label: "فارسی", dir: "rtl" },
  { code: "ru", label: "Русский" },
];

const activeLangCode = languages.some(l => l.code === lang) ? lang : "de";
const currentLang = languages.find((l) => l.code === activeLangCode);

const t = {
  es: { home: "Inicio", modules: "Módulos", contact: "Contacto", current: "Actual" },
  en: { home: "Home", modules: "Modules", contact: "Contact", current: "Current" },
  de: { home: "Start", modules: "Module", contact: "Kontakt", current: "Aktiv" },
  ru: { home: "Главная", modules: "Модули", contact: "Контакты", current: "Тек." },
  fa: { home: "صفحه اصلی", modules: "ماژول‌ها", contact: "تماس", current: "فعلی" }
};

const nav = t[activeLangCode];
---

<nav class="sticky top-0 z-[100] w-full h-16 bg-white/90 backdrop-blur-md border-b border-gray-100 shadow-sm font-inter">
  <div class="max-w-5xl mx-auto px-4 h-full">
    <div class="flex justify-between h-full items-center">
      
      <a href={`${base}${activeLangCode}/`} class="font-black md:text-3xl text-xl text-blue-600 tracking-tighter font-archivo">
        BEBE<span class="text-gray-800">CUTE</span>
      </a>

      <div class="flex items-center gap-2">
        <div class="hidden md:flex items-center gap-8 mr-4">
          <a href={`${base}${activeLangCode}/#home`} class="text-base font-bold text-gray-600 hover:text-purple-600 transition-colors tracking-tight">
            {nav.home}
          </a>
          <a href={`${base}${activeLangCode}/#portfolio`} class="text-base font-bold text-gray-600 hover:text-purple-600 transition-colors tracking-tight">
            {nav.modules}
          </a>
          <a href={`${base}${activeLangCode}/#contact`} class="text-base font-bold text-gray-600 hover:text-purple-600 transition-colors tracking-tight">
            {nav.contact}
          </a>
        </div>

        <div class="relative inline-block text-left">
          <button id="lang-menu-btn" class="flex items-center gap-1.5 bg-gray-50 border border-gray-200 px-2 py-2 md:px-4 md:py-2 rounded-xl hover:bg-gray-100 transition-all group">
            <svg class="w-4 h-4 text-gray-400 group-hover:text-purple-600 transition-colors" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="2" y1="12" x2="22" y2="12"></line>
              <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
            </svg>
            <span class="text-xs md:text-sm font-black text-gray-700 uppercase">{currentLang.code}</span>
          </button>

          <div id="lang-dropdown" class="hidden absolute right-0 mt-2 w-44 md:w-52 bg-white border border-gray-100 rounded-2xl shadow-xl overflow-hidden ring-1 ring-black ring-opacity-5">
            {languages.map((l) => {
              const isActive = l.code === activeLangCode;
              const targetUrl = `${base}${l.code}/${currentSubPath}`;
              return (
                <a href={isActive ? "#" : targetUrl} class:list={["lang-link flex items-center justify-between px-4 py-3.5 text-sm border-b border-gray-50 last:border-0", { "bg-purple-50 text-purple-700 font-bold pointer-events-none": isActive, "text-gray-600 hover:bg-gray-50": !isActive }]}>
                  <div class="flex items-center gap-3">
                    <span class="text-[11px] font-black opacity-30 w-5">{l.code.toUpperCase()}</span>
                    <span>{l.label}</span>
                  </div>
                  {isActive && <span class="text-[9px] bg-purple-600 text-white px-2 py-0.5 rounded-md font-black uppercase tracking-tighter">{nav.current}</span>}
                </a>
              );
            })}
          </div>
        </div>

        <button id="mobile-menu-btn" class="md:hidden p-2 text-gray-600 hover:bg-gray-50 rounded-xl transition-colors">
          <svg id="ham-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
          <svg id="close-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
    </div>
  </div>

  <div id="mobile-menu" class="hidden absolute top-[64px] left-0 w-full bg-white border-b border-gray-100 shadow-2xl md:hidden animate-in fade-in slide-in-from-top-1 duration-200">
    <div class="px-4 pt-2 pb-6 space-y-1">
      <a href={`${base}${activeLangCode}/#home`} class="mobile-nav-link block px-4 py-4 text-lg font-bold text-gray-700 hover:bg-purple-50 hover:text-purple-600 rounded-xl transition-all tracking-tight">
        {nav.home}
      </a>
      <a href={`${base}${activeLangCode}/#portfolio`} class="mobile-nav-link block px-4 py-4 text-lg font-bold text-gray-700 hover:bg-purple-50 hover:text-purple-600 rounded-xl transition-all tracking-tight">
        {nav.modules}
      </a>
      <a href={`${base}${activeLangCode}/#contact`} class="mobile-nav-link block px-4 py-4 text-lg font-bold text-gray-700 hover:bg-purple-50 hover:text-purple-600 rounded-xl transition-all tracking-tight">
        {nav.contact}
      </a>
    </div>
  </div>
</nav>

<script is:inline>
  function setup() {
    const btn = document.getElementById("mobile-menu-btn");
    const menu = document.getElementById("mobile-menu");
    const hamIcon = document.getElementById("ham-icon");
    const closeIcon = document.getElementById("close-icon");
    const langBtn = document.getElementById("lang-menu-btn");
    const langDrop = document.getElementById("lang-dropdown");

    function toggleMenu() {
      const isHidden = menu.classList.toggle("hidden");
      hamIcon.classList.toggle("hidden", !isHidden);
      closeIcon.classList.toggle("hidden", isHidden);
      if (!isHidden) langDrop?.classList.add("hidden");
    }

    btn?.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleMenu();
    });

    langBtn?.addEventListener("click", (e) => {
      e.stopPropagation();
      langDrop?.classList.toggle("hidden");
      if (!menu.classList.contains("hidden")) toggleMenu();
    });

    document.addEventListener("click", (e) => {
      langDrop?.classList.add("hidden");
      if (!menu.contains(e.target) && !menu.classList.contains("hidden")) toggleMenu();
    });

    document.querySelectorAll(".mobile-nav-link").forEach(l => {
      l.addEventListener("click", () => menu.classList.add("hidden"));
    });
  }
  setup();
  document.addEventListener('astro:after-swap', setup);
</script>